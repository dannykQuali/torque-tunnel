spec_version: 2
description: |
  Execute shell commands directly on the Torque agent container.
  This blueprint runs commands locally on the agent without SSH to any remote host.
  Useful for running scripts, tools, or commands that don't require a target machine.

inputs:
  agent:
    type: agent
    description: The Torque agent to use for execution
  command_b64:
    type: string
    description: Base64-encoded shell command(s) to execute on the agent
  init_commands_b64:
    type: string
    description: Base64-encoded init commands (optional)
    default: ""
  finally_commands_b64:
    type: string
    description: Base64-encoded finally commands (optional)
    default: ""

outputs:
  command_output:
    value: '{{ .grains.local_executor.activities.deploy.commands.run_local.outputs.command_output }}'
  exit_code:
    value: '{{ .grains.local_executor.activities.deploy.commands.run_local.outputs.exit_code }}'

grains:
  local_executor:
    kind: shell
    spec:
      agent:
        name: '{{ .inputs.agent }}'
      activities:
        deploy:
          commands:
            - name: run_local
              command: |
                echo "=== Beginning of local execution ============================================================================================================="
                
                OUTPUT_FILE=$(mktemp)
                
                # Decode base64 inputs
                MAIN_CMD=$(echo '{{ .inputs.command_b64 }}' | base64 -d)
                INIT_CMD=$(echo '{{ .inputs.init_commands_b64 }}' | base64 -d 2>/dev/null || true)
                FINALLY_CMD=$(echo '{{ .inputs.finally_commands_b64 }}' | base64 -d 2>/dev/null || true)
                
                # Setup finally trap if provided
                if [ -n "$FINALLY_CMD" ]; then
                  eval "__finally() { $FINALLY_CMD; }"
                  trap __finally EXIT
                fi
                
                # Run init commands if provided
                if [ -n "$INIT_CMD" ]; then
                  echo "=== Running init commands ==="
                  eval "$INIT_CMD"
                fi
                
                echo "=== Executing on agent container ==="
                echo "=== Output (streaming) ========================================================================================================================="
                
                # Run the main command
                set +e
                eval "$MAIN_CMD" 2>&1 | tee "$OUTPUT_FILE"
                CMD_EXIT_CODE=${PIPESTATUS[0]}
                set -e
                
                COMMAND_OUTPUT=$(cat "$OUTPUT_FILE")
                rm -f "$OUTPUT_FILE"
                
                export command_output="$COMMAND_OUTPUT"
                export exit_code="$CMD_EXIT_CODE"
                
                echo ""
                echo "=== Command completed with exit code: $CMD_EXIT_CODE ==="
              outputs:
                - command_output
                - exit_code

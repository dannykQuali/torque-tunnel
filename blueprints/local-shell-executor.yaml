spec_version: 2
description: |
  Execute shell commands directly on the Torque agent container.
  This blueprint runs commands locally on the agent without SSH to any remote host.
  Useful for running scripts, tools, or commands that don't require a target machine.

inputs:
  agent:
    type: agent
    description: The Torque agent to use for execution
  command_b64:
    type: string
    description: Base64-encoded shell command(s) to execute on the agent
  init_commands_b64:
    type: string
    description: Base64-encoded init commands (optional)
    default: ""
  finally_commands_b64:
    type: string
    description: Base64-encoded finally commands (optional)
    default: ""

outputs:
  command_output:
    value: '{{ .grains.local_executor.activities.deploy.commands.run_local.outputs.command_output }}'
  exit_code:
    value: '{{ .grains.local_executor.activities.deploy.commands.run_local.outputs.exit_code }}'

grains:
  local_executor:
    kind: shell
    spec:
      agent:
        name: '{{ .inputs.agent }}'
      activities:
        deploy:
          commands:
            - name: run_local
              command: |
                echo "=== Beginning of local execution ============================================================================================================="
                
                OUTPUT_FILE=$(mktemp)
                SCRIPT_FILE=$(mktemp)
                
                # Decode base64 inputs directly to files
                echo '{{ .inputs.command_b64 }}' | base64 -d > "$SCRIPT_FILE"
                
                INIT_FILE=$(mktemp)
                echo '{{ .inputs.init_commands_b64 }}' | base64 -d > "$INIT_FILE" 2>/dev/null || true
                
                FINALLY_FILE=$(mktemp)
                echo '{{ .inputs.finally_commands_b64 }}' | base64 -d > "$FINALLY_FILE" 2>/dev/null || true
                
                # Build combined script
                COMBINED=$(mktemp)
                echo '#!/bin/bash' > "$COMBINED"
                
                # Add finally trap if provided
                if [ -s "$FINALLY_FILE" ]; then
                  echo '__finally() {' >> "$COMBINED"
                  cat "$FINALLY_FILE" >> "$COMBINED"
                  echo '}' >> "$COMBINED"
                  echo 'trap __finally EXIT' >> "$COMBINED"
                fi
                
                # Add init commands if provided
                if [ -s "$INIT_FILE" ]; then
                  echo "=== Running init commands ==="
                  cat "$INIT_FILE" >> "$COMBINED"
                fi
                
                # Add main command
                cat "$SCRIPT_FILE" >> "$COMBINED"
                
                chmod +x "$COMBINED"
                
                echo "=== Executing on agent container ==="
                echo "=== Output (streaming) ========================================================================================================================="
                
                # Run the script
                set +e
                bash "$COMBINED" 2>&1 | tee "$OUTPUT_FILE"
                CMD_EXIT_CODE=${PIPESTATUS[0]}
                set -e
                
                # Base64 encode output to safely pass special characters
                COMMAND_OUTPUT_B64=$(base64 < "$OUTPUT_FILE" | tr -d '\n')
                rm -f "$OUTPUT_FILE" "$SCRIPT_FILE" "$INIT_FILE" "$FINALLY_FILE" "$COMBINED"
                
                export command_output="$COMMAND_OUTPUT_B64"
                export exit_code="$CMD_EXIT_CODE"
                
                echo ""
                echo "=== Command completed with exit code: $CMD_EXIT_CODE ==="
              outputs:
                - command_output
                - exit_code

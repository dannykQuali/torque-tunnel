spec_version: 2
description: |
  Execute shell commands directly on the Torque agent container.
  This blueprint runs commands locally on the agent without SSH to any remote host.
  Useful for running scripts, tools, or commands that don't require a target machine.

inputs:
  agent:
    type: agent
    description: The Torque agent to use for execution
  command:
    type: file
    description: The shell script to execute on the agent (content will be written to a file)
  init_commands:
    type: file
    description: Commands to run before the main command (e.g., environment setup)
    default: ""
  finally_commands:
    type: file
    description: Commands to run after the main command (cleanup, always runs)
    default: ""

outputs:
  command_output:
    value: '{{ .grains.local_executor.activities.deploy.commands.run_local.outputs.command_output }}'
  exit_code:
    value: '{{ .grains.local_executor.activities.deploy.commands.run_local.outputs.exit_code }}'

grains:
  local_executor:
    kind: shell
    spec:
      agent:
        name: '{{ .inputs.agent }}'
      activities:
        deploy:
          commands:
            - name: run_local
              command: |
                echo "=== Beginning of local execution ============================================================================================================="
                
                OUTPUT_FILE=$(mktemp)
                
                # Setup finally trap if provided
                if [ -s "{{ .inputs.finally_commands }}" ]; then
                  trap 'source "{{ .inputs.finally_commands }}"' EXIT
                fi
                
                # Run init commands if provided
                if [ -s "{{ .inputs.init_commands }}" ]; then
                  echo "=== Running init commands ==="
                  source "{{ .inputs.init_commands }}"
                fi
                
                echo "=== Executing on agent container ==="
                echo "=== Output (streaming) ========================================================================================================================="
                
                # Run the main command
                set +e
                source "{{ .inputs.command }}" 2>&1 | tee "$OUTPUT_FILE"
                CMD_EXIT_CODE=${PIPESTATUS[0]}
                set -e
                
                COMMAND_OUTPUT=$(cat "$OUTPUT_FILE")
                rm -f "$OUTPUT_FILE"
                
                export command_output="$COMMAND_OUTPUT"
                export exit_code="$CMD_EXIT_CODE"
                
                echo ""
                echo "=== Command completed with exit code: $CMD_EXIT_CODE ==="
              outputs:
                - command_output
                - exit_code

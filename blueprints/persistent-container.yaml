spec_version: 2
description: |
  Launch a persistent container with SSH access on the Torque agent.
  The container runs dropbear (lightweight SSH server) in foreground and stays alive
  until the environment is terminated.
  Used by the torque-tunnel MCP tool to provide persistent container sessions.
  
  Connection details (IP and private key) are output via the deploy log.
  The container is based on the same Ubuntu 22.04 image used by Torque shell grains.

inputs:
  agent:
    type: agent
    description: The Torque agent to use for the persistent container

outputs:
  container_ready:
    value: '{{ .grains.persistent_sshd.activities.deploy.commands.setup_sshd.outputs.container_ready }}'

grains:
  persistent_sshd:
    kind: shell
    spec:
      agent:
        name: '{{ .inputs.agent }}'
      activities:
        deploy:
          commands:
            - name: setup_sshd
              command: |
                set -e
                
                # Install dropbear - lightweight SSH server (~100KB vs ~5MB for openssh-server)
                # Try without apt-get update first (uses cached index from base image, ~5s)
                # Fall back to apt-get update if cache is stale (~90s)
                apt-get install -y -qq dropbear-bin 2>&1 || \
                  (apt-get update -qq 2>&1 && apt-get install -y -qq dropbear-bin 2>&1)
                
                # Generate host keys for dropbear
                mkdir -p /etc/dropbear
                dropbearkey -t rsa -s 2048 -f /etc/dropbear/dropbear_rsa_host_key > /dev/null 2>&1
                dropbearkey -t ecdsa -f /etc/dropbear/dropbear_ecdsa_host_key > /dev/null 2>&1
                
                # Generate an RSA keypair for authentication
                # (RSA used because dropbearconvert reliably converts RSA to OpenSSH format)
                mkdir -p /root/.ssh
                dropbearkey -t rsa -s 2048 -f /root/.ssh/container_key > /dev/null 2>&1
                
                # Extract public key in OpenSSH format for authorized_keys
                dropbearkey -y -f /root/.ssh/container_key | grep "^ssh-rsa" >> /root/.ssh/authorized_keys
                chmod 600 /root/.ssh/authorized_keys
                
                # Convert private key to OpenSSH PEM format (required by Torque shell grain)
                dropbearconvert dropbear openssh /root/.ssh/container_key /root/.ssh/container_key_openssh
                
                # Output connection details with unique TORQUE_TUNNEL:: prefix
                # so the parser can distinguish actual output from the script echo
                # that Torque prints before execution
                _SA_IP=$(hostname -I | awk '{print $1}')
                _SA_ID=$(hostname)
                _SA_KEY=$(cat /root/.ssh/container_key_openssh)
                
                printf 'TORQUE_TUNNEL::CONTAINER_IP=%s\n' "$_SA_IP"
                printf 'TORQUE_TUNNEL::CONTAINER_ID=%s\n' "$_SA_ID"
                printf 'TORQUE_TUNNEL::KEY_START\n'
                printf '%s\n' "$_SA_KEY"
                printf 'TORQUE_TUNNEL::KEY_END\n'
                printf 'TORQUE_TUNNEL::READY\n'
                
                export container_ready="true"
                
                # Start dropbear in foreground - this keeps the container alive
                # -F: foreground, -E: log to stderr, -s: disable password auth, -p 22: listen port
                exec dropbear -F -E -s -p 22
              outputs:
                - container_ready
